/**
   \class    standalone_LumiReWeighting standalone_LumiReWeighting.h "PhysicsTools/Utilities/interface/standalone_LumiReWeighting.h"
   \brief    Class to provide lumi weighting for analyzers to weight "flat-to-N" MC samples to data

   This class will trivially take two histograms:
   1. The generated "flat-to-N" distributions from a given processing (or any other generated input)
   2. A histogram generated from the "estimatePileup" macro here:

   https://twiki.cern.ch/twiki/bin/view/CMS/LumiCalc#How_to_use_script_estimatePileup

   and produce weights to convert the input distribution (1) to the latter (2).

   \author Shin-Shan Eiko Yu, Salvatore Rappoccio, modified by Mike Hildreth
  
*/
#ifndef standalone_LumiReWeighting_cxx
#define standalone_LumiReWeighting_cxx
#include "TH1.h"
#include "TFile.h"
#include <string>
#include "standalone_LumiReWeighting.h"

//=======================================================
// For 2012 Data and MC
//=======================================================

Double_t Summer2012_S10[60] = {
  2.560E-06,
  5.239E-06,
  1.420E-05,
  5.005E-05,
  1.001E-04,
  2.705E-04,
  1.999E-03,
  6.097E-03,
  1.046E-02,
  1.383E-02,
  1.685E-02,
  2.055E-02,
  2.572E-02,
  3.262E-02,
  4.121E-02,
  4.977E-02,
  5.539E-02,
  5.725E-02,
  5.607E-02,
  5.312E-02,
  5.008E-02,
  4.763E-02,
  4.558E-02,
  4.363E-02,
  4.159E-02,
  3.933E-02,
  3.681E-02,
  3.406E-02,
  3.116E-02,
  2.818E-02,
  2.519E-02,
  2.226E-02,
  1.946E-02,
  1.682E-02,
  1.437E-02,
  1.215E-02,
  1.016E-02,
  8.400E-03,
  6.873E-03,
  5.564E-03,
  4.457E-03,
  3.533E-03,
  2.772E-03,
  2.154E-03,
  1.656E-03,
  1.261E-03,
  9.513E-04,
  7.107E-04,
  5.259E-04,
  3.856E-04,
  2.801E-04,
  2.017E-04,
  1.439E-04,
  1.017E-04,
  7.126E-05,
  4.948E-05,
  3.405E-05,
  2.322E-05,
  1.570E-05,
  5.005E-06};


Double_t Summer2012_S7[60] = {
  2.344E-05,
  2.344E-05,
  2.344E-05,
  2.344E-05,
  4.687E-04,
  4.687E-04,
  7.032E-04,
  9.414E-04,
  1.234E-03,
  1.603E-03,
  2.464E-03,
  3.250E-03,
  5.021E-03,
  6.644E-03,
  8.502E-03,
  1.121E-02,
  1.518E-02,
  2.033E-02,
  2.608E-02,
  3.171E-02,
  3.667E-02,
  4.060E-02,
  4.338E-02,
  4.520E-02,
  4.641E-02,
  4.735E-02,
  4.816E-02,
  4.881E-02,
  4.917E-02,
  4.909E-02,
  4.842E-02,
  4.707E-02,
  4.501E-02,
  4.228E-02,
  3.896E-02,
  3.521E-02,
  3.118E-02,
  2.702E-02,
  2.287E-02,
  1.885E-02,
  1.508E-02,
  1.166E-02,
  8.673E-03,
  6.190E-03,
  4.222E-03,
  2.746E-03,
  1.698E-03,
  9.971E-04,
  5.549E-04,
  2.924E-04,
  1.457E-04,
  6.864E-05,
  3.054E-05,
  1.282E-05,
  5.081E-06,
  1.898E-06,
  6.688E-07,
  2.221E-07,
  6.947E-08,
  2.047E-08
};  

double Data2012[60]={
  12238.3,
  32262.5,
  89446.2,
  334234,
  615757,
  2.98985e+06,
  1.72461e+07,
  5.09728e+07,
  1.20392e+08,
  2.42357e+08,
  4.17686e+08,
  6.29916e+08,
  7.95702e+08,
  8.87215e+08,
  9.43283e+08,
  9.83983e+08,
  1.00815e+09,
  1.01641e+09,
  1.01158e+09,
  9.93914e+08,
  9.66494e+08,
  9.33319e+08,
  8.95274e+08,
  8.48627e+08,
  7.87443e+08,
  7.09182e+08,
  6.16799e+08,
  5.16143e+08,
  4.13618e+08,
  3.16027e+08,
  2.29893e+08,
  1.5946e+08,
  1.05639e+08,
  6.68014e+07,
  4.0203e+07,
  2.29422e+07,
  1.23864e+07,
  6.33305e+06,
  3.08228e+06,
  1.44202e+06,
  657965,
  298258,
  137015,
  64820.2,
  31787.7,
  16081.1,
  8287.87,
  4289.65,
  2202.88,
  1112.69,
  549.679,
  264.639,
  123.898,
  56.3314,
  24.8509,
  10.6313,
  4.40873,
  1.77169,
  0.689782,
  0.260138
};


double Data2012Up[60]={
  11510.2,
  22529.6,
  80563,
  255399,
  549450,
  1.5764e+06,
  1.03988e+07,
  3.43332e+07,
  8.20029e+07,
  1.72024e+08,
  3.07175e+08,
  4.89037e+08,
  6.73288e+08,
  7.95806e+08,
  8.63492e+08,
  9.09974e+08,
  9.43488e+08,
  9.62485e+08,
  9.68134e+08,
  9.62654e+08,
  9.46087e+08,
  9.21187e+08,
  8.91289e+08,
  8.57303e+08,
  8.16495e+08,
  7.63868e+08,
  6.96481e+08,
  6.15821e+08,
  5.26343e+08,
  4.33246e+08,
  3.41985e+08,
  2.5822e+08,
  1.86562e+08,
  1.29202e+08,
  8.58329e+07,
  5.46235e+07,
  3.32001e+07,
  1.92136e+07,
  1.05726e+07,
  5.53994e+06,
  2.77819e+06,
  1.34525e+06,
  637032,
  299776,
  142627,
  69608.6,
  35093.6,
  18230.7,
  9663.54,
  5161.96,
  2747.36,
  1444.42,
  745.731,
  376.632,
  185.632,
  89.1509,
  41.6788,
  18.9558,
  8.38325,
  3.60402
};

double Data2012Down[60]={
  13062.9,
  44407.7,
  104453,
  431294,
  770833,
  5.78192e+06,
  2.77178e+07,
  7.66716e+07,
  1.77682e+08,
  3.40049e+08,
  5.63402e+08,
  7.78519e+08,
  9.07268e+08,
  9.77585e+08,
  1.02705e+09,
  1.05778e+09,
  1.06953e+09,
  1.06565e+09,
  1.04682e+09,
  1.01648e+09,
  9.79463e+08,
  9.36544e+08,
  8.82659e+08,
  8.10887e+08,
  7.19579e+08,
  6.13631e+08,
  5.0056e+08,
  3.88388e+08,
  2.85527e+08,
  1.98918e+08,
  1.31617e+08,
  8.27601e+07,
  4.9329e+07,
  2.77528e+07,
  1.469e+07,
  7.31716e+06,
  3.44757e+06,
  1.55315e+06,
  680200,
  295873,
  130802,
  59826.3,
  28468.3,
  13982.8,
  6979.01,
  3482.84,
  1715.91,
  827.477,
  388.501,
  177.012,
  78.1182,
  33.3519,
  13.7651,
  5.48911,
  2.11411,
  0.786207,
  0.282248,
  0.0977982,
  0.0327016,
  0.0105509
};

double Data2012AB[60]={
  0.223516,
  25.8075,
  2351.55,
  108612,
  268471,
  1.90027e+06,
  1.04981e+07,
  2.71424e+07,
  5.54473e+07,
  9.6718e+07,
  1.51618e+08,
  2.13609e+08,
  2.65407e+08,
  3.00605e+08,
  3.26343e+08,
  3.45545e+08,
  3.4915e+08,
  3.3622e+08,
  3.14297e+08,
  2.90056e+08,
  2.68352e+08,
  2.52931e+08,
  2.44914e+08,
  2.40746e+08,
  2.32957e+08,
  2.14909e+08,
  1.85442e+08,
  1.47536e+08,
  1.06784e+08,
  6.9313e+07,
  3.98601e+07,
  2.01579e+07,
  8.93546e+06,
  3.46912e+06,
  1.18145e+06,
  354734,
  94898.1,
  23026.4,
  5197.28,
  1122.76,
  237.463,
  49.5914,
  10.1747,
  2.02972,
  0.390504,
  0.0721848,
  0.0128062,
  0.00217838,
  0.000354464,
  5.49583e-05,
  8.0806e-06,
  1.1215e-06,
  1.4629e-07,
  1.78541e-08,
  2.05299e-09,
  2.02801e-10,
  0,
  0,
  0,
  0
};


double Data2012ABUp[60]={
  0.148557,
  18.2664,
  1226.84,
  60640.9,
  255564,
  919867,
  6.60171e+06,
  1.91216e+07,
  4.0348e+07,
  7.27575e+07,
  1.16497e+08,
  1.71426e+08,
  2.252e+08,
  2.66543e+08,
  2.94373e+08,
  3.16521e+08,
  3.314e+08,
  3.31462e+08,
  3.18047e+08,
  2.97704e+08,
  2.75697e+08,
  2.55982e+08,
  2.41664e+08,
  2.33841e+08,
  2.29966e+08,
  2.24179e+08,
  2.10302e+08,
  1.86398e+08,
  1.54038e+08,
  1.17349e+08,
  8.14035e+07,
  5.08171e+07,
  2.83063e+07,
  1.40061e+07,
  6.14548e+06,
  2.39118e+06,
  826872,
  255536,
  71323.4,
  18284.3,
  4404.03,
  1021.55,
  232.599,
  52.3634,
  11.6066,
  2.51038,
  0.525855,
  0.106269,
  0.0206927,
  0.0038799,
  0.000699421,
  0.000120863,
  1.99424e-05,
  3.12883e-06,
  4.64965e-07,
  6.52845e-08,
  8.56987e-09,
  1.08471e-09,
  8.82189e-11,
  0
};

double Data2012ABDown[60]={
  0.344462,
  39.6011,
  4753.77,
  174365,
  343330,
  3.75385e+06,
  1.60453e+07,
  3.8747e+07,
  7.61792e+07,
  1.28897e+08,
  1.96074e+08,
  2.59746e+08,
  3.05442e+08,
  3.3612e+08,
  3.59999e+08,
  3.68222e+08,
  3.56389e+08,
  3.32807e+08,
  3.05993e+08,
  2.81983e+08,
  2.65346e+08,
  2.57148e+08,
  2.52424e+08,
  2.4178e+08,
  2.18367e+08,
  1.82255e+08,
  1.38358e+08,
  9.40039e+07,
  5.62515e+07,
  2.93008e+07,
  1.32075e+07,
  5.14151e+06,
  1.72973e+06,
  505109,
  129355,
  29601.8,
  6225.4,
  1243.6,
  242.433,
  46.5942,
  8.77441,
  1.59975,
  0.279923,
  0.0468395,
  0.00748728,
  0.00114162,
  0.00016547,
  2.26834e-05,
  2.92449e-06,
  3.52748e-07,
  3.96928e-08,
  4.11229e-09,
  3.77351e-10,
  2.04314e-11,
  0,
  0,
  0,
  0,
  0,
  0
};


//=======================================================
// For 2011 Data and MC
//=======================================================

Double_t Fall2011[50] = {
  0.003388501,
  0.010357558,
  0.024724258,
  0.042348605,
  0.058279812,
  0.068851751,
  0.072914824,
  0.071579609,
  0.066811668,
  0.060672356,
  0.054528356,
  0.04919354,
  0.044886042,
  0.041341896,
  0.0384679,
  0.035871463,
  0.03341952,
  0.030915649,
  0.028395374,
  0.025798107,
  0.023237445,
  0.020602754,
  0.0180688,
  0.015559693,
  0.013211063,
  0.010964293,
  0.008920993,
  0.007080504,
  0.005499239,
  0.004187022,
  0.003096474,
  0.002237361,
  0.001566428,
  0.001074149,
  0.000721755,
  0.000470838,
  0.00030268,
  0.000184665,
  0.000112883,
  6.74043E-05,
  3.82178E-05,
  2.22847E-05,
  1.20933E-05,
  6.96173E-06,
  3.4689E-06,
  1.96172E-06,
  8.49283E-07,
  5.02393E-07,
  2.15311E-07,
  9.56938E-08
};


double Data2011[50]={
  5.07024e+06,
  1.25241e+06,
  9.03288e+06,
  1.15106e+08,
  3.56113e+08,
  5.05445e+08,
  5.15838e+08,
  4.69266e+08,
  4.24162e+08,
  3.98722e+08,
  3.71911e+08,
  3.46841e+08,
  3.27692e+08,
  3.01809e+08,
  2.58952e+08,
  1.98323e+08,
  1.31701e+08,
  7.46387e+07,
  3.57587e+07,
  1.44475e+07,
  4.97014e+06,
  1.4923e+06,
  405908,
  104272,
  26235.1,
  6600.02,
  1659.27,
  415.404,
  109.906,
  41.2309,
  33.2132,
  43.8802,
  63.9808,
  91.6263,
  126.102,
  166.165,
  209.506,
  252.713,
  291.616,
  321.941,
  340.153,
  343.94,
  332.511,
  307.736,
  272.51,
  230.858,
  187.096,
  145.067,
  107.618,
  76.3918
};

double Data2011Up[50]={
  5.01089e+06,
  1.15407e+06,
  5.97158e+06,
  7.88451e+07,
  2.90835e+08,
  4.60041e+08,
  4.98014e+08,
  4.64675e+08,
  4.19087e+08,
  3.89226e+08,
  3.67961e+08,
  3.42229e+08,
  3.22879e+08,
  3.0469e+08,
  2.7688e+08,
  2.32927e+08,
  1.75234e+08,
  1.15356e+08,
  6.56347e+07,
  3.20356e+07,
  1.33956e+07,
  4.84198e+06,
  1.54594e+06,
  450181,
  123968,
  33354.9,
  8955.57,
  2407.16,
  643.666,
  174.949,
  56.3123,
  31.9003,
  34.8057,
  48.5878,
  69.5207,
  96.7445,
  129.626,
  166.92,
  206.5,
  245.404,
  280.142,
  307.214,
  323.747,
  327.857,
  318.729,
  297.838,
  267.405,
  230.625,
  191.063,
  152.057
};

double Data2011Down[50]={
  5.13071e+06,
  1.41095e+06,
  1.4471e+07,
  1.64152e+08,
  4.268e+08,
  5.46143e+08,
  5.288e+08,
  4.73097e+08,
  4.32847e+08,
  4.06601e+08,
  3.75696e+08,
  3.52948e+08,
  3.28549e+08,
  2.87695e+08,
  2.2503e+08,
  1.51263e+08,
  8.55545e+07,
  4.02287e+07,
  1.5665e+07,
  5.10339e+06,
  1.43125e+06,
  360929,
  85884.8,
  20077,
  4699.5,
  1096.48,
  256.996,
  69.7713,
  35.4979,
  39.7273,
  58.0342,
  85.6779,
  121.581,
  164.519,
  212.022,
  260.171,
  303.964,
  338.138,
  358.297,
  361.584,
  347.27,
  317.767,
  276.884,
  229.704,
  181.44,
  136.467,
  97.7427,
  66.6703,
  43.3105,
  26.7966
};


standalone_LumiReWeighting::standalone_LumiReWeighting(int year,int mode) {

  std::cout << "=======================================================================" << std::endl;
  
  std::vector<double> MC_distr;
  std::vector<double> Lumi_distr;

  MC_distr.clear();
  Lumi_distr.clear();
  std::cout << "Year " << year << std::endl;
  if(year!=2011 && year!=2012)
    {
      std::cout << "The year is not correct!! Reset to year 2012." << 
	std::endl;
      year=2012;
      std::cout << "Year " << year << std::endl;
    }
  switch (mode)
    {
    case 0:
      std::cout << "Using central value " << std::endl;
      break;
    case 1:
      std::cout << "Using +1 sigma 5% value " << std::endl;
      break;
    case -1:
      std::cout << "Using -1 sigma 5% value " << std::endl;
      break;
    case 2:
      std::cout << "Using old pileup JSON value" << std::endl;
      break;
    default:
      std::cout << "Using central value " << std::endl;
      break;
    } // end of switch

  Int_t NBins = 60;
  if(year==2011) NBins = 50;
  
  for( int i=0; i< NBins; ++i) {
    if(year==2011)
      {
	switch (mode){
	case 0:
	  Lumi_distr.push_back(Data2011[i]);
	  break;
	case 1:
	  Lumi_distr.push_back(Data2011Up[i]);
	  break;
	case -1:
	  Lumi_distr.push_back(Data2011Down[i]);
	  break;
	default:
	  Lumi_distr.push_back(Data2011[i]);
	  break;
	} // end of switch
	MC_distr.push_back(Fall2011[i]);
      }

    else if(year==2012)
      {
	switch (mode){
	case 0:
	  Lumi_distr.push_back(Data2012[i]);
	  break;
	case 1:
	  Lumi_distr.push_back(Data2012Up[i]);
	  break;
	case -1:
	  Lumi_distr.push_back(Data2012Down[i]);
	  break;
	case 2:
	  Lumi_distr.push_back(Data2012AB[i]);
	  break;
	default:
	  Lumi_distr.push_back(Data2012[i]);
	  break;
	} // end of switch
	MC_distr.push_back(Summer2012_S10[i]);
      }

  } // end of loop over bins

  // no histograms for input: use vectors
  
  // now, make histograms out of them:

  // first, check they are the same size...

  if( MC_distr.size() != Lumi_distr.size() ){   
    std::cout << "MC_distr.size() = " << MC_distr.size() << std::endl;
    std::cout << "Lumi_distr.size() = " << Lumi_distr.size() << std::endl;
    std::cerr <<"ERROR: standalone_LumiReWeighting: input vectors have different sizes. Quitting... \n";

  }


  weights_ = new TH1D(Form("luminumer_%d",mode),
 		      Form("luminumer_%d",mode),
 		      NBins,0.0, double(NBins));

  TH1D* den = new TH1D(Form("lumidenom_%d",mode),
 		       Form("lumidenom_%d",mode),
 		       NBins,0.0, double(NBins));


  
  for(int ibin = 1; ibin<NBins+1; ++ibin ) {
    weights_->SetBinContent(ibin, Lumi_distr[ibin-1]);
    den->SetBinContent(ibin,MC_distr[ibin-1]);
  }

  std::cout << "Data Input " << std::endl;
  for(int ibin = 1; ibin<NBins+1; ++ibin){
    std::cout << "   " << ibin-1 << " " << weights_->GetBinContent(ibin) << std::endl;
  }
  std::cout << "MC Input " << std::endl;
  for(int ibin = 1; ibin<NBins+1; ++ibin){
    std::cout << "   " << ibin-1 << " " << den->GetBinContent(ibin) << std::endl;
  }

  // check integrals, make sure things are normalized

  double deltaH = weights_->Integral();
  if(fabs(1.0 - deltaH) > 0.02 ) { //*OOPS*...
    weights_->Scale( 1.0/ weights_->Integral() );
  }
  double deltaMC = den->Integral();
  if(fabs(1.0 - deltaMC) > 0.02 ) {
    den->Scale(1.0/ den->Integral());
  }

  weights_->Divide( den );  // so now the average weight should be 1.0    

  std::cout << "Reweighting: Computed Weights per In-Time Nint " << std::endl;


  for(int ibin = 1; ibin<NBins+1; ++ibin){
    std::cout << "   " << ibin-1 << " " << weights_->GetBinContent(ibin) << std::endl;
  }

  std::cout << "=======================================================================" << std::endl;

}

standalone_LumiReWeighting::~standalone_LumiReWeighting()
{
}



double standalone_LumiReWeighting::weight( double npv ) {
  int bin = weights_->GetXaxis()->FindBin( npv );
  return weights_->GetBinContent( bin );
}


#endif
